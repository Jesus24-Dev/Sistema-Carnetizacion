<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Carnetización - Subir Foto</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="card shadow-lg border-0 rounded-3">
                        <!-- Header -->
                        <div class="card-header bg-primary text-white text-center py-4">
                            <h2 class="h3 fw-bold mb-2">Subir Foto para Carnet</h2>
                            <p class="mb-0 opacity-75">Complete el proceso subiendo su fotografía</p>
                        </div>
                        
                        <div class="card-body p-4 p-md-5">
                            <!-- Alert de error -->
                            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span th:text="${error}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>

                            <div class="row g-4">
                                <!-- Formulario de subida -->
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <h4 class="fw-bold text-dark mb-3">Subir Fotografía</h4>
                                        <form th:action="@{'/carnet/' + ${ci} + '/uploadImage'}" 
                                              method="POST" 
                                              enctype="multipart/form-data"
                                              class="needs-validation"
                                              novalidate
                                              id="uploadForm">
                                              
                                            <!-- Área de dropzone -->
                                            <div class="border-2 border-dashed rounded-3 p-4 mb-3 text-center bg-light"
                                                 style="border-style: dashed !important; border-color: #6c757d !important;"
                                                 id="dropzone">
                                                <div class="py-4">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-up text-muted mb-3" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                                                        <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
                                                    </svg>
                                                    <p class="mb-2 fw-semibold">Seleccione o arrastre su fotografía</p>
                                                    <p class="text-muted small mb-3">Formato: JPG solamente (Máx. 5MB)</p>
                                                    <input type="file" 
                                                           name="image" 
                                                           id="image" 
                                                           accept=".jpg,.jpeg,image/jpeg"
                                                           class="d-none"
                                                           required>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('image').click()">
                                                        <i class="fas fa-folder-open me-2"></i>Seleccionar Archivo JPG
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Vista previa -->
                                            <div id="previewContainer" class="text-center mb-3 d-none">
                                                <img id="preview" class="img-thumbnail rounded-3" style="max-height: 200px;">
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearImage()">
                                                        <i class="fas fa-times me-1"></i>Quitar imagen
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Información del archivo -->
                                            <div id="fileInfo" class="small text-muted text-center mb-3"></div>

                                            <!-- Mensaje de validación -->
                                            <div id="validationMessage" class="alert alert-warning d-none small">
                                                <i class="fas fa-exclamation-circle me-2"></i>
                                                <span id="validationText"></span>
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg py-2 fw-semibold" id="submitButton">
                                                    <i class="fas fa-upload me-2"></i>Subir Imagen y Completar Registro
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Requisitos -->
                                <div class="col-md-6">
                                    <div class="bg-light rounded-3 p-4 h-100">
                                        <h4 class="fw-bold text-dark mb-3">
                                            <i class="fas fa-clipboard-list me-2 text-primary"></i>Requisitos de la Fotografía
                                        </h4>
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-3 d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Formato JPG solamente</strong>
                                                    <p class="text-muted small mb-0">Solo se aceptan archivos .jpg o .jpeg</p>
                                                </div>
                                            </li>
                                            <li class="mb-3 d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Rostro reconocible</strong>
                                                    <p class="text-muted small mb-0">El rostro debe ser claramente visible y nítido</p>
                                                </div>
                                            </li>
                                            <li class="mb-3 d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Fondo blanco</strong>
                                                    <p class="text-muted small mb-0">Fondo completamente blanco y liso</p>
                                                </div>
                                            </li>
                                            <li class="mb-3 d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Cabello recogido</strong>
                                                    <p class="text-muted small mb-0">Cabello fuera del rostro y orejas</p>
                                                </div>
                                            </li>
                                            <li class="mb-3 d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Sin vello facial</strong>
                                                    <p class="text-muted small mb-0">Rostro completamente afeitado</p>
                                                </div>
                                            </li>
                                            <li class="d-flex align-items-start">
                                                <span class="badge bg-success me-3 mt-1">✓</span>
                                                <div>
                                                    <strong>Sin accesorios</strong>
                                                    <p class="text-muted small mb-0">Sin gafas, gorras, aretes grandes, etc.</p>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- Ejemplo visual -->
                                        <div class="mt-4 pt-3 border-top">
                                            <h6 class="fw-semibold mb-2">Ejemplo correcto:</h6>
                                            <div class="bg-white border rounded-2 p-2 text-center">
                                                <div class="bg-primary bg-opacity-10 rounded-2 p-3">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                                            <i class="fas fa-user text-muted fa-2x"></i>
                                                        </div>
                                                        <div class="text-start">
                                                            <div class="fw-semibold text-dark">Formato JPG</div>
                                                            <div class="small text-muted">Rostro centrado · Fondo blanco</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/js/bootstrap.bundle.min.js"></script>
        <script>
            // Validación del formulario
            (function() {
                'use strict';
                window.addEventListener('load', function() {
                    var forms = document.getElementsByClassName('needs-validation');
                    var validation = Array.prototype.filter.call(forms, function(form) {
                        form.addEventListener('submit', function(event) {
                            if (!validateImage()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });
                }, false);
            })();

            // Elementos del DOM
            const imageInput = document.getElementById('image');
            const previewContainer = document.getElementById('previewContainer');
            const preview = document.getElementById('preview');
            const fileInfo = document.getElementById('fileInfo');
            const dropzone = document.getElementById('dropzone');
            const validationMessage = document.getElementById('validationMessage');
            const validationText = document.getElementById('validationText');
            const submitButton = document.getElementById('submitButton');
            const uploadForm = document.getElementById('uploadForm');

            // Función de validación de imagen
            function validateImage() {
                const file = imageInput.files[0];
                let isValid = true;
                
                if (!file) {
                    showValidationMessage('Por favor seleccione una imagen JPG.', 'danger');
                    return false;
                }

                // Validar tipo de archivo (solo JPG)
                const allowedTypes = ['image/jpeg', 'image/jpg'];
                if (!allowedTypes.includes(file.type)) {
                    showValidationMessage('Solo se permiten archivos JPG (.jpg, .jpeg). Formato detectado: ' + file.type, 'danger');
                    isValid = false;
                }

                // Validar tamaño (5MB máximo)
                if (file.size > 5 * 1024 * 1024) {
                    showValidationMessage('El archivo es demasiado grande. Máximo 5MB permitido.', 'danger');
                    isValid = false;
                }

                // Validar extensión por nombre de archivo (segunda verificación)
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.jpg') && !fileName.endsWith('.jpeg')) {
                    showValidationMessage('La extensión del archivo debe ser .jpg o .jpeg', 'danger');
                    isValid = false;
                }

                if (isValid) {
                    hideValidationMessage();
                }

                // Habilitar/deshabilitar botón de envío
                submitButton.disabled = !isValid;
                
                return isValid;
            }

            function showValidationMessage(message, type) {
                validationText.textContent = message;
                validationMessage.className = `alert alert-${type} small`;
                validationMessage.classList.remove('d-none');
            }

            function hideValidationMessage() {
                validationMessage.classList.add('d-none');
            }

            // Manejo de la imagen
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar la imagen
                    const isValid = validateImage();

                    if (isValid) {
                        // Mostrar preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            previewContainer.classList.remove('d-none');
                            dropzone.classList.add('d-none');
                            
                            // Mostrar información del archivo
                            fileInfo.innerHTML = `
                                <i class="fas fa-file-image me-1 text-success"></i>
                                <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)
                                <br><span class="text-success">✓ Formato JPG válido</span>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Limpiar si no es válido
                        clearImage();
                    }
                }
            });

            // Funcionalidad drag & drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropzone.classList.add('bg-primary', 'bg-opacity-10');
            }

            function unhighlight() {
                dropzone.classList.remove('bg-primary', 'bg-opacity-10');
            }

            dropzone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    imageInput.dispatchEvent(new Event('change'));
                }
            }

            // Limpiar imagen seleccionada
            function clearImage() {
                imageInput.value = '';
                previewContainer.classList.add('d-none');
                fileInfo.innerHTML = '';
                dropzone.classList.remove('d-none');
                hideValidationMessage();
                submitButton.disabled = false;
            }

            // Hacer clickable toda el área del dropzone
            dropzone.addEventListener('click', function() {
                imageInput.click();
            });

            // Validación adicional antes del envío
            uploadForm.addEventListener('submit', function(e) {
                if (!validateImage()) {
                    e.preventDefault();
                    showValidationMessage('Por favor corrija los errores antes de enviar el formulario.', 'danger');
                }
            });
        </script>
    </body>
</html>