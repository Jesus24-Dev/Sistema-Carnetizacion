<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Carnetización - Panel de Administración</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </head>
    <body class="bg-light">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="fas fa-id-card me-2"></i>
                    Sistema de Carnetización
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-home me-1"></i>Inicio
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-cog me-1"></i>Configuración
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Notificaciones -->
                    <div class="navbar-nav ms-3">
                        <div class="nav-item dropdown">
                            <a class="nav-link position-relative" href="#" id="notificationsDropdown" 
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bell fa-lg"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge">
                                    0
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" 
                                style="width: 400px; max-height: 500px; overflow-y: auto;"
                                aria-labelledby="notificationsDropdown">
                                <li class="dropdown-header fw-bold text-dark">
                                    <i class="fas fa-bell me-2 text-warning"></i>
                                    Notificaciones
                                    <span class="badge bg-primary ms-2" id="notificationCount">0 nuevas</span>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <div id="notificationsList">
                                    <li class="px-3 py-2 text-center text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <p class="mb-0">No hay notificaciones nuevas</p>
                                    </li>
                                </div>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-center text-primary small" href="#">
                                        <i class="fas fa-sync-alt me-1"></i>Marcar todas como leídas
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Usuario -->
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" 
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-shield me-1"></i>Administrador
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li>
                                    <form th:action="@{/logout}" method="post" class="mb-0">
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-2 col-md-3 mb-4">
                    <div class="card shadow-sm border-0 rounded-3">
                        <div class="card-body">
                            <h6 class="fw-bold text-uppercase text-muted small mb-3">Navegación</h6>
                            <ul class="nav nav-pills flex-column">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#">
                                        <i class="fas fa-users me-2"></i>Empleados
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">
                                        <i class="fas fa-clock me-2"></i>Pendientes
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">
                                        <i class="fas fa-check-circle me-2"></i>Aprobados
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">
                                        <i class="fas fa-chart-bar me-2"></i>Reportes
                                    </a>
                                </li>
                            </ul>
                            
                            <hr class="my-3">
                            
                            <h6 class="fw-bold text-uppercase text-muted small mb-3">Estadísticas</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">Total Empleados:</span>
                                <span class="badge bg-primary" th:text="${#lists.size(employees)}">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">Pendientes:</span>
                                <span class="badge bg-warning" id="pendingCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">Aprobados:</span>
                                <span class="badge bg-success" id="approvedCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="col-lg-10 col-md-9">
                    <!-- Header Stats -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card bg-primary text-white shadow border-0 rounded-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title text-white-50 small fw-bold">Total Empleados</h6>
                                            <h3 class="mb-0 fw-bold" th:text="${#lists.size(employees)}">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-users fa-2x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card bg-warning text-white shadow border-0 rounded-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title text-white-50 small fw-bold">Pendientes</h6>
                                            <h3 class="mb-0 fw-bold" id="statsPending">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card bg-success text-white shadow border-0 rounded-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title text-white-50 small fw-bold">Aprobados</h6>
                                            <h3 class="mb-0 fw-bold" id="statsApproved">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card bg-info text-white shadow border-0 rounded-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title text-white-50 small fw-bold">Nuevos Hoy</h6>
                                            <h3 class="mb-0 fw-bold" id="statsToday">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-bolt fa-2x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employees Table -->
                    <div class="card shadow-sm border-0 rounded-3">
                        <div class="card-header bg-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-list me-2 text-primary"></i>Lista de Empleados
                                </h5>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar empleado..." id="searchInput">
                                    <button class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-download me-1"></i>Exportar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped mb-0" id="employeesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">Cédula</th>
                                            <th>Nombre</th>
                                            <th>Apellido</th>
                                            <th>Sexo</th>
                                            <th>Correo</th>
                                            <th>Fecha Nacimiento</th>
                                            <th>Estado</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="emp : ${employees}">
                                            <td class="ps-4 fw-semibold" th:text="${emp.ci}"></td>
                                            <td th:text="${emp.name}"></td>
                                            <td th:text="${emp.lastname}"></td>
                                            <td>
                                                <span th:if="${emp.gender.gender == 'MALE'}" class="badge bg-primary">MASCULINO</span>
                                                <span th:if="${emp.gender.gender == 'FEMALE'}" class="badge bg-pink">FEMENINO</span>
                                            </td>
                                            <td>
                                                <small class="text-muted" th:text="${emp.email}"></small>
                                            </td>
                                            <td>
                                                <small th:text="${#temporals.format(emp.birthday, 'dd/MM/yyyy')}"></small>
                                            </td>
                                            <td>
                                                <span th:switch="${emp.licenseStatus}" class="badge">
                                                    <span th:case="'PENDIENTE'" class="bg-warning">PENDIENTE</span>
                                                    <span th:case="'APROBADO'" class="bg-success">APROBADO</span>
                                                    <span th:case="'RECHAZADO'" class="bg-danger">RECHAZADO</span>
                                                    <span th:case="*" class="bg-secondary" th:text="${emp.licenseStatus}"></span>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <a th:href="@{/admin/employee/{ci}(ci=${emp.ci})}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>Ver Carnet
                                                </a>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(employees)}">
                                            <td colspan="8" class="text-center py-4 text-muted">
                                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                                <p class="mb-0">No hay empleados registrados</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="tableInfo">Mostrando <span th:text="${#lists.size(employees)}">0</span> empleados</small>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast para nuevas notificaciones -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-warning text-dark">
                    <i class="fas fa-bell me-2"></i>
                    <strong class="me-auto">Nueva Solicitud</strong>
                    <small>Ahora mismo</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage">
                    Tienes una nueva solicitud de carnet pendiente.
                </div>
            </div>
        </div>

        <script src="/js/bootstrap.bundle.min.js"></script>
        <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
        <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
        <script>
            // WebSocket Connection
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            let notificationCount = 0;

            stompClient.connect({}, function(frame) {
                console.log('✅ WebSocket conectado:', frame);

                stompClient.subscribe('/topic/notificaciones', function(mensaje) {
                    const notificacion = JSON.parse(mensaje.body);
                    console.log('📨 Nueva notificación:', notificacion);
                    
                    // Actualizar contadores
                    notificationCount++;
                    updateNotificationBadge();
                    
                    // Agregar notificación a la lista
                    addNotification(notificacion);
                    
                    // Mostrar toast
                    showNotificationToast(notificacion);
                    
                    // Actualizar estadísticas
                    updateStatistics(notificacion);
                });
            }, function(error) {
                console.error('❌ Error de conexión WebSocket:', error);
            });

            function updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const countSpan = document.getElementById('notificationCount');
                
                if (notificationCount > 0) {
                    badge.textContent = notificationCount;
                    badge.classList.remove('d-none');
                    countSpan.textContent = notificationCount + ' nuevas';
                } else {
                    badge.classList.add('d-none');
                    countSpan.textContent = '0 nuevas';
                }
            }

            function addNotification(notificacion) {
                const notificationsList = document.getElementById('notificationsList');
                
                // Limpiar mensaje de "no hay notificaciones"
                if (notificationsList.querySelector('.text-center')) {
                    notificationsList.innerHTML = '';
                }
                
                const notificationItem = document.createElement('li');
                notificationItem.className = 'dropdown-item';
                notificationItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <div class="me-3">
                            <i class="fas fa-user-plus text-success me-2"></i>
                            <strong>Nueva solicitud</strong>
                        </div>
                        <small class="text-muted">Ahora</small>
                    </div>
                    <p class="mb-1 small text-muted">Cédula: ${notificacion.ci || 'N/A'}</p>
                    <small class="text-muted">${notificacion.nombre || 'Nuevo empleado registrado'}</small>
                `;
                
                notificationsList.insertBefore(notificationItem, notificationsList.firstChild);
            }

            function showNotificationToast(notificacion) {
                const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                const toastMessage = document.getElementById('toastMessage');
                
                toastMessage.textContent = `Nueva solicitud de ${notificacion.nombre || 'empleado'} (CI: ${notificacion.ci || 'N/A'})`;
                toast.show();
            }

            function updateStatistics(notificacion) {
                // Actualizar contadores en tiempo real
                const pendingCount = document.getElementById('pendingCount');
                const statsPending = document.getElementById('statsPending');
                const statsToday = document.getElementById('statsToday');
                
                if (pendingCount && statsPending) {
                    const current = parseInt(pendingCount.textContent) || 0;
                    pendingCount.textContent = current + 1;
                    statsPending.textContent = current + 1;
                }
                
                if (statsToday) {
                    const currentToday = parseInt(statsToday.textContent) || 0;
                    statsToday.textContent = currentToday + 1;
                }
            }

            // Búsqueda en tiempo real
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#employeesTable tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
                
                // Actualizar información de la tabla
                const visibleRows = document.querySelectorAll('#employeesTable tbody tr[style=""]');
                document.getElementById('tableInfo').textContent = `Mostrando ${visibleRows.length} empleados`;
            });

            // Inicializar contadores basados en datos iniciales
            document.addEventListener('DOMContentLoaded', function() {
                // Contar empleados por estado
                const pendingRows = document.querySelectorAll('.bg-warning');
                const approvedRows = document.querySelectorAll('.bg-success');
                
                document.getElementById('pendingCount').textContent = pendingRows.length;
                document.getElementById('statsPending').textContent = pendingRows.length;
                document.getElementById('approvedCount').textContent = approvedRows.length;
                document.getElementById('statsApproved').textContent = approvedRows.length;
                
                // Simular algunas notificaciones para demo
                updateNotificationBadge();
            });

            // Estilo para badge femenino
            const style = document.createElement('style');
            style.textContent = `
                .bg-pink { background-color: #e83e8c !important; }
                .table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.075) !important; }
                .dropdown-menu { min-width: 300px; }
            `;
            document.head.appendChild(style);
        </script>
    </body>
</html>